<head>
    <title>Track Streamer App</title>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="/fontawesome-free/css/all.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="/css/adminlte.min.css">
    <link rel="stylesheet" href="/bootstrap.min.css">

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <script type="text/javascript" charset="utf-8">
        // Wait for device API libraries to load
        document.addEventListener("deviceready", onDeviceReady, false);
      
        // device APIs are available
        function onDeviceReady() {
            console.log("Device is ready now!");
            // Now safe to use device APIs
        }
    </script>

    <!--  PeerJS Code Here  -->
    <script type="text/javascript" charset="utf-8">
        // const peerID = 'gdkh23mrsd500000';
        // const destId = 'imwu98plfw300000';
        //
        // const peer = new Peer(peerID, {
        //     host: location.hostname,
        //     port: location.port || (location.protocol === 'https:' ? 443 : 80),
        //     path: '/peerjs',
        //     debug: 3
        // });
        //
        // peer.on('open', function(id) {
        //     console.log('My peer ID is: ' + id);
        //     console.log(peer.options);
        // });
        //
        // // Start new connection
        // const conn = peer.connect(destId);
        //
        // // Receive connection
        // peer.on('connection', function(conn) {
        //     console.log("Receiving connection..");
        //
        //     conn.on('error', function (err) {
        //         console.log("Error ", err);
        //     });
        //
        //     // Send messages
        //     console.log("Sending message");
        //     conn.send('Hello!');
        // });

        // conn.on('error', function (err) {
        //    console.log("Error ", err);
        // });
        //
        // conn.on('connection', function () {
        //     console.log("Peer Connected!");
        // });
        //
        // conn.on('open', function() {
        //     // Receive messages
        //     conn.on('data', function(data) {
        //         console.log('Received', data);
        //     });
        //
        //     // Send messages
        //     console.log("Sending message");
        //     conn.send('Hello!');
        // });

    </script>

    <!-- jQuery -->
    <script src="/jquery/jquery.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- AdminLTE App -->
    <script src="/js/adminlte.min.js"></script>
</head>

<body>
    <h1>Track Streamer App</h1>

    <!-- Peer Table Part -->
    {{> peerTable}}

    <!-- Video Streaming Part -->
    <div class="display-cover">
        <video style="width: 100%;height: 100%" autoplay></video>
        <canvas class="d-none"></canvas>
  
        <div class="video-options">
            <select name="" id="" class="custom-select">
                <option value="">Select camera</option>
            </select>
        </div>
  
        <img class="screenshot-image d-none" alt="">
  
        <div class="controls">
            <button class="btn btn-danger play" title="Play"><i data-feather="play-circle"></i></button>
            <button class="btn btn-info pause d-none" title="Pause"><i data-feather="pause"></i></button>
            <button class="btn btn-outline-success screenshot d-none" title="ScreenShot"><i data-feather="image"></i></button>
        </div>
    </div>
  
    <script src="/js/feather.min.js"></script>

    <script>const controls = document.querySelector('.controls');
        const cameraOptions = document.querySelector('.video-options>select');
        const video = document.querySelector('video');
        const canvas = document.querySelector('canvas');
        const screenshotImage = document.querySelector('img');
        const buttons = [...controls.querySelectorAll('button')];
        let streamStarted = false;
  
        const [play, pause, screenshot] = buttons;
  
        const constraints = {
            video: {
                width: {
                    min: 1280,
                    ideal: 1920,
                    max: 2560,
                },
                height: {
                    min: 720,
                    ideal: 1080,
                    max: 1440
                },
                facingMode: {
                    exact: 'environment'
                }
            }
        };
  
        const getCameraSelection = async () => {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            console.log(videoDevices);
            const options = videoDevices.map(videoDevice => {
                return `<option value="${videoDevice.deviceId}">${videoDevice.label}</option>`;
            });
            cameraOptions.innerHTML = options.join('');
        };
  
        play.onclick = () => {
            if (streamStarted) {
                video.play();
                play.classList.add('d-none');
                pause.classList.remove('d-none');
                return;
            }
            if ('mediaDevices' in navigator && navigator.mediaDevices.getUserMedia) {
                const updatedConstraints = {
                    ...constraints,
                    deviceId: {
                        exact: cameraOptions.value
                    }
                };
                console.log(updatedConstraints);
                startStream(updatedConstraints);
            }
        };
  
        const startStream = async (constraints) => {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            handleStream(stream);
        };
  
        const handleStream = (stream) => {
            video.srcObject = stream;
            play.classList.add('d-none');
            pause.classList.remove('d-none');
            screenshot.classList.remove('d-none');
            streamStarted = true;
        };
  
        getCameraSelection();

        cameraOptions.onchange = () => {
            const updatedConstraints = {
                ...constraints,
                deviceId: {
                    exact: cameraOptions.value
                }
            };
            startStream(updatedConstraints);
        };
  
        const pauseStream = () => {
            video.pause();
            play.classList.remove('d-none');
            pause.classList.add('d-none');
        };
  
        const doScreenshot = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            screenshotImage.src = canvas.toDataURL('image/webp');
            screenshotImage.classList.remove('d-none');
        };

        pause.onclick = pauseStream;
        screenshot.onclick = doScreenshot;
    </script>

</body>

<template name="peerTable">
    <table class="control">
        <tr>
            <td class="title">Status:</td>
            <td class="title">Messages:</td>
        </tr>
        <tr>
            <td>
                <span style="font-weight: bold">ID: </span>
                <input type="text" id="receiver-id" title="Input the ID from receive.html" value="{{recvIdInput}}">
                <button id="connect-button">Connect</button>
            </td>
            <td>
                <input type="text" id="sendMessageBox" placeholder="Enter a message..." autofocus="true" />
                <button type="button" id="sendButton">Send</button>
                <button type="button" id="clearMsgsButton">Clear Msgs (Local)</button>
            </td>
        </tr>
        <tr>
            <td><div id="status" class="status">{{status}}</div></td>
            <td><div class="message" id="message">{{{message}}}</div></td>
        </tr>
    </table>
</template>
